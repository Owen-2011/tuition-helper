<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â≠¶Ë¥πÂä©Êâã - ËØæÂ§ñÊú∫ÊûÑÂ≠¶Ë¥πÁÆ°ÁêÜÂ∑•ÂÖ∑</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0a7ea4;
            --background: #ffffff;
            --surface: #f5f5f5;
            --foreground: #11181c;
            --muted: #687076;
            --border: #e5e7eb;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--background);
            color: var(--foreground);
            height: 100vh;
            overflow: hidden;
        }

        #root {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .app-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background-color: var(--background);
        }

        .app-header h1 {
            font-size: 28px;
            margin-bottom: 4px;
        }

        .app-header p {
            font-size: 14px;
            color: var(--muted);
        }

        .tab-nav {
            display: flex;
            border-bottom: 1px solid var(--border);
            background-color: var(--background);
            padding: 0 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 16px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--muted);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .tab-btn:hover {
            color: var(--foreground);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .app-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .search-bar input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }

        .students-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .student-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .student-card:hover {
            background: var(--background);
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .student-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .student-name {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }

        .status-badge {
            background: var(--success);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .course-list {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .course-item {
            font-size: 13px;
            color: var(--muted);
            margin: 6px 0;
            padding: 6px 0;
        }

        .course-item-name {
            font-weight: 600;
            color: var(--foreground);
        }

        .student-card-footer {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .fee-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin: 4px 0;
        }

        .fee-row.final {
            font-weight: 600;
            color: var(--primary);
            margin-top: 8px;
        }

        .fee-label {
            color: var(--muted);
        }

        .fee-value {
            font-weight: 600;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 40px 20px;
            text-align: center;
        }

        .empty-message {
            font-size: 16px;
            color: var(--muted);
        }

        .btn-add-first {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-add-first:hover {
            opacity: 0.9;
            transform: scale(1.02);
        }

        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(10, 126, 164, 0.3);
            transition: all 0.2s ease;
            z-index: 100;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(10, 126, 164, 0.4);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-container {
            background: var(--background);
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            font-size: 20px;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--muted);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--foreground);
        }

        .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(10, 126, 164, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .help-text {
            display: block;
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
        }

        .courses-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .courses-section h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--foreground);
        }

        .course-input-group {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .course-input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 8px;
            font-family: inherit;
        }

        .course-input-group input:last-child {
            margin-bottom: 0;
        }

        .course-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 8px;
            align-items: flex-end;
        }

        .course-input-row input {
            margin-bottom: 0;
        }

        .btn-remove-course {
            background: var(--error);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
        }

        .btn-remove-course:hover {
            opacity: 0.9;
        }

        .btn-add-course {
            background: var(--surface);
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            margin-top: 8px;
        }

        .btn-add-course:hover {
            background: var(--primary);
            color: white;
        }

        .discount-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .discount-section h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--foreground);
        }

        .discount-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .discount-row .form-group {
            margin-bottom: 0;
        }

        .discount-row input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .discount-row input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(10, 126, 164, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            padding: 20px;
            border-top: 1px solid var(--border);
        }

        .btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-cancel {
            background: var(--surface);
            color: var(--foreground);
            border: 1px solid var(--border);
        }

        .btn-cancel:hover {
            background: var(--border);
        }

        .btn-error {
            background: var(--error);
            color: white;
        }

        .btn-error:hover {
            opacity: 0.9;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .summary-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .summary-label {
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin: 20px 0 12px 0;
            color: var(--foreground);
        }

        .students-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .detail-section {
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .info-row.final {
            font-weight: 600;
            color: var(--primary);
            border-bottom: none;
            padding-top: 16px;
        }

        .info-label {
            color: var(--muted);
        }

        .info-value {
            font-weight: 600;
        }

        .info-value.final {
            color: var(--primary);
            font-size: 18px;
        }

        @media (max-width: 600px) {
            .app-header {
                padding: 16px;
            }

            .app-header h1 {
                font-size: 24px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .fab {
                bottom: 16px;
                right: 16px;
                width: 48px;
                height: 48px;
                font-size: 24px;
            }

            .course-input-row {
                grid-template-columns: 1fr;
            }

            .discount-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="app-header">
            <h1>Â≠¶Ë¥πÂä©Êâã</h1>
            <p>ËØæÂ§ñÊú∫ÊûÑÂ≠¶Ë¥πÁÆ°ÁêÜÂ∑•ÂÖ∑</p>
        </div>

        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('students')">üìö Â≠¶Áîü</button>
            <button class="tab-btn" onclick="switchTab('summary')">üìä ÁªüËÆ°</button>
        </div>

        <div class="app-content">
            <!-- Students Tab -->
            <div id="students-tab" class="tab-content active">
                <div class="search-bar">
                    <input type="text" id="search-input" placeholder="ÊêúÁ¥¢Â≠¶ÁîüÊàñËØæÁ®ã..." onkeyup="handleSearch()">
                </div>
                <div id="students-list" class="students-list"></div>
            </div>

            <!-- Summary Tab -->
            <div id="summary-tab" class="tab-content">
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-label">ÊÄªÂ≠¶ÁîüÊï∞</div>
                        <div class="summary-value" id="total-students">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">ÂæÖÁªìÁÆó</div>
                        <div class="summary-value" id="unsettled-count">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">ÂæÖÁªìÁÆóÈáëÈ¢ù</div>
                        <div class="summary-value" id="unsettled-amount">¬•0.00</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Â∑≤ÁªìÁÆóÈáëÈ¢ù</div>
                        <div class="summary-value" id="settled-amount">¬•0.00</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">ÊÄªÈáëÈ¢ù</div>
                        <div class="summary-value" id="total-amount">¬•0.00</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-label">Âπ≥ÂùáÂçï‰ª∑</div>
                        <div class="summary-value" id="avg-price">¬•0.00</div>
                    </div>
                </div>

                <div id="settled-list-container" style="margin-top: 30px;"></div>
            </div>
        </div>
    </div>

    <!-- Form Modal -->
    <div id="form-modal" class="modal-overlay" onclick="if(event.target === this) closeForm()">
        <div class="modal-container">
            <div class="modal-header">
                <h2 id="form-title">Ê∑ªÂä†Â≠¶Áîü</h2>
                <button class="close-btn" onclick="closeForm()">‚úï</button>
            </div>
            <form id="student-form" class="modal-content" onsubmit="handleFormSubmit(event)">
                <div class="form-group">
                    <label for="name">Â≠¶ÁîüÂßìÂêç *</label>
                    <input type="text" id="name" placeholder="ËæìÂÖ•Â≠¶ÁîüÂßìÂêç" required>
                </div>

                <div class="courses-section">
                    <h3>ËØæÁ®ã‰ø°ÊÅØ</h3>
                    <div id="courses-container"></div>
                    <button type="button" class="btn-add-course" onclick="addCourseInput()">+ Ê∑ªÂä†ËØæÁ®ã</button>
                </div>

                <div class="discount-section">
                    <h3>ÂáèÂÖç‰ø°ÊÅØ</h3>
                    <div class="discount-row">
                        <div class="form-group">
                            <label for="classRemaining">ËØæ‰ΩôÂáèÂÖçÔºàÂÖÉÔºâ</label>
                            <input type="number" id="classRemaining" placeholder="ËæìÂÖ•ËØæ‰ΩôÂáèÂÖçÈáëÈ¢ù" value="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="discountPrice">‰ºòÊÉ†‰ª∑Ê†ºÔºàÂÖÉÔºâ</label>
                            <input type="number" id="discountPrice" placeholder="ËæìÂÖ•‰ºòÊÉ†ÈáëÈ¢ù" value="0" step="0.01">
                        </div>
                    </div>
                </div>
            </form>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="closeForm()">ÂèñÊ∂à</button>
                <button type="button" class="btn btn-primary" onclick="submitForm()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detail-modal" class="modal-overlay" onclick="if(event.target === this) closeDetail()">
        <div class="modal-container">
            <div class="modal-header">
                <div>
                    <h2 id="detail-name"></h2>
                    <p id="detail-courses" style="margin: 0; font-size: 13px; color: var(--muted);"></p>
                </div>
                <span id="detail-badge" class="status-badge" style="display: none;">Â∑≤ÁªìÁÆó</span>
                <button class="close-btn" onclick="closeDetail()">‚úï</button>
            </div>

            <div class="modal-content" id="detail-content"></div>

            <div class="modal-actions">
                <button type="button" class="btn btn-primary" onclick="editCurrentStudent()">ÁºñËæë</button>
                <button type="button" class="btn btn-error" onclick="deleteCurrentStudent()">Âà†Èô§</button>
                <button type="button" class="btn btn-cancel" onclick="closeDetail()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>

    <button class="fab" id="fab-btn" onclick="openForm()">+</button>

    <script>
        // Storage Key
        const STORAGE_KEY = 'tuition_manager_students_v3';

        // State
        let students = [];
        let editingStudentId = null;
        let selectedStudentId = null;

        // Initialize
        function init() {
            loadStudents();
            renderStudents();
            renderSummary();
        }

        // Storage Functions
        function loadStudents() {
            const data = localStorage.getItem(STORAGE_KEY);
            students = data ? JSON.parse(data) : [];
        }

        function saveStudents() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(students));
        }

        function generateId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Calculate Financial
        function calculateFinancial(student) {
            let totalFee = 0;
            let absenceFee = 0;

            student.courses.forEach(course => {
                const courseFee = course.classes * course.pricePerClass;
                const courseAbsenceFee = course.absenceCount * course.pricePerClass;
                totalFee += courseFee;
                absenceFee += courseAbsenceFee;
            });

            const classRemaining = student.classRemaining || 0;
            const discountPrice = student.discountPrice || 0;
            const finalFee = Math.max(0, totalFee - absenceFee - classRemaining - discountPrice);
            return { totalFee, absenceFee, classRemaining, discountPrice, finalFee };
        }

        function formatCurrency(value) {
            return `¬•${value.toFixed(2)}`;
        }

        // Tab Switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabName + '-tab').classList.add('active');
            
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => {
                if (btn.textContent.includes(tabName === 'students' ? 'Â≠¶Áîü' : 'ÁªüËÆ°')) {
                    btn.classList.add('active');
                }
            });
        }

        // Search
        function handleSearch() {
            renderStudents();
        }

        function getFilteredStudents() {
            const query = document.getElementById('search-input').value.toLowerCase();
            if (query.trim() === '') {
                return students;
            }
            return students.filter(s => {
                const nameMatch = s.name.toLowerCase().includes(query);
                const courseMatch = s.courses.some(c => c.name.toLowerCase().includes(query));
                return nameMatch || courseMatch;
            });
        }

        // Render Students
        function renderStudents() {
            const filtered = getFilteredStudents();
            const unsettled = filtered.filter(s => !s.isSettled);
            const settled = filtered.filter(s => s.isSettled);

            let html = '';

            if (unsettled.length > 0) {
                html += `<h3 class="section-title">ÂæÖÁªìÁÆó (${unsettled.length})</h3>`;
                html += '<div class="students-section">';
                unsettled.forEach(student => {
                    html += renderStudentCard(student);
                });
                html += '</div>';
            }

            if (settled.length > 0) {
                html += `<h3 class="section-title">Â∑≤ÁªìÁÆó (${settled.length})</h3>`;
                html += '<div class="students-section">';
                settled.forEach(student => {
                    html += renderStudentCard(student);
                });
                html += '</div>';
            }

            if (filtered.length === 0) {
                html = `
                    <div class="empty-state">
                        <p class="empty-message">${document.getElementById('search-input').value.trim() === '' ? 'ÊöÇÊó†Â≠¶ÁîüËÆ∞ÂΩï' : 'Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÂ≠¶Áîü'}</p>
                        ${document.getElementById('search-input').value.trim() === '' ? '<button class="btn-add-first" onclick="openForm()">Ê∑ªÂä†Á¨¨‰∏Ä‰∏™Â≠¶Áîü</button>' : ''}
                    </div>
                `;
            }

            document.getElementById('students-list').innerHTML = html;
        }

        function renderStudentCard(student) {
            const financial = calculateFinancial(student);
            const badge = student.isSettled ? '<span class="status-badge">Â∑≤ÁªìÁÆó</span>' : '';
            
            const coursesList = student.courses.map(course => {
                const courseFee = course.classes * course.pricePerClass;
                const courseAbsenceFee = course.absenceCount * course.pricePerClass;
                const courseFinal = Math.max(0, courseFee - courseAbsenceFee);
                
                let absenceText = '';
                if (course.absenceCount > 0) {
                    absenceText = ` (Áº∫Âã§${course.absenceCount}ËäÇÔºåÂáèÂÖç${formatCurrency(courseAbsenceFee)})`;
                }
                
                return `<div class="course-item"><span class="course-item-name">${course.name}</span>Ôºö${course.classes}ËäÇ √ó ${formatCurrency(course.pricePerClass)}/ËäÇ = ${formatCurrency(courseFinal)}${absenceText}</div>`;
            }).join('');

            let discountInfo = '';
            if (student.classRemaining > 0 || student.discountPrice > 0) {
                discountInfo = '<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 12px; color: var(--muted);">';
                if (student.classRemaining > 0) {
                    discountInfo += `ËØæ‰ΩôÂáèÂÖçÔºö${formatCurrency(student.classRemaining)} `;
                }
                if (student.discountPrice > 0) {
                    discountInfo += `‰ºòÊÉ†Ôºö${formatCurrency(student.discountPrice)}`;
                }
                discountInfo += '</div>';
            }

            return `
                <div class="student-card" onclick="openDetail('${student.id}')">
                    <div class="student-card-header">
                        <h3 class="student-name">${student.name}</h3>
                        ${badge}
                    </div>
                    <div class="course-list">
                        ${coursesList}
                        ${discountInfo}
                    </div>
                    <div class="student-card-footer">
                        <div class="fee-row">
                            <span class="fee-label">Â∫îÊî∂Â≠¶Ë¥πÔºö</span>
                            <span class="fee-value">${formatCurrency(financial.totalFee)}</span>
                        </div>
                        ${(financial.absenceFee > 0 || financial.classRemaining > 0 || financial.discountPrice > 0) ? `
                            <div class="fee-row" style="color: var(--warning); font-size: 12px;">
                                <span class="fee-label">ÂáèÂÖçÂêàËÆ°Ôºö</span>
                                <span class="fee-value">-${formatCurrency(financial.absenceFee + financial.classRemaining + financial.discountPrice)}</span>
                            </div>
                        ` : ''}
                        <div class="fee-row final">
                            <span class="fee-label">ÊúÄÁªàÂ∫îÊî∂Ôºö</span>
                            <span class="fee-value">${formatCurrency(financial.finalFee)}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Render Summary
        function renderSummary() {
            const stats = calculateStats();
            
            document.getElementById('total-students').textContent = stats.totalStudents;
            document.getElementById('unsettled-count').textContent = stats.unsettledCount;
            document.getElementById('unsettled-amount').textContent = formatCurrency(stats.unsettledAmount);
            document.getElementById('settled-amount').textContent = formatCurrency(stats.settledAmount);
            document.getElementById('total-amount').textContent = formatCurrency(stats.totalAmount);
            document.getElementById('avg-price').textContent = formatCurrency(stats.avgPrice);

            // Render settled list
            const settled = students.filter(s => s.isSettled);
            let settledHtml = '';
            
            if (settled.length > 0) {
                settledHtml = `
                    <h3 class="section-title">Â∑≤ÁªìÁÆóÂ≠¶Áîü (${settled.length})</h3>
                    <div class="students-section">
                        ${settled.map(s => {
                            const financial = calculateFinancial(s);
                            return `
                                <div class="student-card" onclick="openDetail('${s.id}')">
                                    <div class="student-card-header">
                                        <h3 class="student-name">${s.name}</h3>
                                        <span class="status-badge">Â∑≤ÁªìÁÆó</span>
                                    </div>
                                    <div class="student-card-footer">
                                        <div class="fee-row final">
                                            <span class="fee-label">Â∫îÊî∂Ôºö</span>
                                            <span class="fee-value">${formatCurrency(financial.finalFee)}</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            document.getElementById('settled-list-container').innerHTML = settledHtml;
        }

        function calculateStats() {
            const totalStudents = students.length;
            const unsettledStudents = students.filter(s => !s.isSettled);
            const unsettledCount = unsettledStudents.length;
            
            let unsettledAmount = 0;
            let settledAmount = 0;
            let totalAmount = 0;
            let totalPrice = 0;
            let priceCount = 0;

            students.forEach(student => {
                const financial = calculateFinancial(student);
                totalAmount += financial.finalFee;

                student.courses.forEach(course => {
                    totalPrice += course.pricePerClass;
                    priceCount++;
                });

                if (student.isSettled) {
                    settledAmount += financial.finalFee;
                } else {
                    unsettledAmount += financial.finalFee;
                }
            });

            const avgPrice = priceCount > 0 ? totalPrice / priceCount : 0;

            return {
                totalStudents,
                unsettledCount,
                unsettledAmount,
                settledAmount,
                totalAmount,
                avgPrice
            };
        }

        // Form Functions
        function openForm(studentId = null) {
            editingStudentId = studentId;
            const modal = document.getElementById('form-modal');

            if (studentId) {
                const student = students.find(s => s.id === studentId);
                document.getElementById('form-title').textContent = 'ÁºñËæëÂ≠¶Áîü';
                document.getElementById('name').value = student.name;
                document.getElementById('classRemaining').value = student.classRemaining || 0;
                document.getElementById('discountPrice').value = student.discountPrice || 0;
                renderCourseInputs(student.courses);
            } else {
                document.getElementById('form-title').textContent = 'Ê∑ªÂä†Â≠¶Áîü';
                document.getElementById('name').value = '';
                document.getElementById('classRemaining').value = 0;
                document.getElementById('discountPrice').value = 0;
                renderCourseInputs([]);
            }

            modal.classList.add('show');
        }

        function renderCourseInputs(courses = []) {
            let html = '';
            
            if (courses.length === 0) {
                courses = [{ name: '', classes: '', pricePerClass: '', absenceCount: 0 }];
            }

            courses.forEach((course, index) => {
                html += `
                    <div class="course-input-group">
                        <input type="text" placeholder="ËØæÁ®ãÂêçÁß∞" value="${course.name || ''}" onchange="updateCourseInput(${index}, 'name', this.value)">
                        <div class="course-input-row">
                            <input type="number" placeholder="ËØæËäÇÊï∞" value="${course.classes || ''}" onchange="updateCourseInput(${index}, 'classes', this.value)">
                            <input type="number" placeholder="Âçï‰ª∑" value="${course.pricePerClass || ''}" onchange="updateCourseInput(${index}, 'pricePerClass', this.value)">
                            <input type="number" placeholder="Áº∫Âã§" value="${course.absenceCount || 0}" onchange="updateCourseInput(${index}, 'absenceCount', this.value)">
                            ${courses.length > 1 ? `<button type="button" class="btn-remove-course" onclick="removeCourseInput(${index})">Âà†Èô§</button>` : ''}
                        </div>
                    </div>
                `;
            });

            document.getElementById('courses-container').innerHTML = html;
        }

        let courseInputs = [];

        function updateCourseInput(index, field, value) {
            if (!courseInputs[index]) {
                courseInputs[index] = { name: '', classes: '', pricePerClass: '', absenceCount: 0 };
            }
            courseInputs[index][field] = field === 'absenceCount' ? parseInt(value) || 0 : value;
        }

        function removeCourseInput(index) {
            const inputs = document.querySelectorAll('.course-input-group');
            if (inputs.length > 1) {
                courseInputs.splice(index, 1);
                renderCourseInputs(courseInputs);
            }
        }

        function addCourseInput() {
            courseInputs.push({ name: '', classes: '', pricePerClass: '', absenceCount: 0 });
            renderCourseInputs(courseInputs);
        }

        function closeForm() {
            document.getElementById('form-modal').classList.remove('show');
            editingStudentId = null;
            courseInputs = [];
        }

        function submitForm() {
            const name = document.getElementById('name').value.trim();
            
            // Êî∂ÈõÜËØæÁ®ã‰ø°ÊÅØ
            const courseInputs = [];
            document.querySelectorAll('.course-input-group').forEach((group, index) => {
                const inputs = group.querySelectorAll('input');
                const courseName = inputs[0].value.trim();
                const classes = parseInt(inputs[1].value);
                const pricePerClass = parseFloat(inputs[2].value);
                const absenceCount = parseInt(inputs[3].value) || 0;

                if (courseName && !isNaN(classes) && !isNaN(pricePerClass)) {
                    courseInputs.push({
                        name: courseName,
                        classes,
                        pricePerClass,
                        absenceCount
                    });
                }
            });

            if (!name) {
                alert('ËØ∑ËæìÂÖ•Â≠¶ÁîüÂßìÂêç');
                return;
            }

            if (courseInputs.length === 0) {
                alert('ËØ∑Ëá≥Â∞ëÊ∑ªÂä†‰∏Ä‰∏™ËØæÁ®ã');
                return;
            }

            const classRemaining = parseFloat(document.getElementById('classRemaining').value) || 0;
            const discountPrice = parseFloat(document.getElementById('discountPrice').value) || 0;

            if (editingStudentId) {
                const student = students.find(s => s.id === editingStudentId);
                student.name = name;
                student.courses = courseInputs;
                student.classRemaining = classRemaining;
                student.discountPrice = discountPrice;
                student.updatedAt = Date.now();
            } else {
                const newStudent = {
                    id: generateId(),
                    name,
                    courses: courseInputs,
                    classRemaining: classRemaining,
                    discountPrice: discountPrice,
                    isSettled: false,
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };
                students.push(newStudent);
            }

            saveStudents();
            closeForm();
            renderStudents();
            renderSummary();
            alert(editingStudentId ? 'Â≠¶Áîü‰ø°ÊÅØÂ∑≤Êõ¥Êñ∞' : 'Â≠¶ÁîüÂ∑≤Ê∑ªÂä†');
        }

        // Detail Functions
        function openDetail(studentId) {
            selectedStudentId = studentId;
            const student = students.find(s => s.id === studentId);
            const financial = calculateFinancial(student);

            document.getElementById('detail-name').textContent = student.name;
            
            const courseNames = student.courses.map(c => c.name).join('„ÄÅ');
            document.getElementById('detail-courses').textContent = `ËØæÁ®ãÔºö${courseNames}`;
            
            const badge = document.getElementById('detail-badge');
            if (student.isSettled) {
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }

            let content = '<div class="detail-section">';
            
            student.courses.forEach(course => {
                const courseFee = course.classes * course.pricePerClass;
                const courseAbsenceFee = course.absenceCount * course.pricePerClass;
                const courseFinal = Math.max(0, courseFee - courseAbsenceFee);
                
                content += `
                    <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border);">
                        <div style="font-weight: 600; margin-bottom: 8px; color: var(--foreground);">${course.name}</div>
                        <div class="info-row">
                            <span class="info-label">ËØæËäÇÊï∞Ôºö</span>
                            <span class="info-value">${course.classes}ËäÇ</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Âçï‰ª∑Ôºö</span>
                            <span class="info-value">${formatCurrency(course.pricePerClass)}/ËäÇ</span>
                        </div>
                        ${course.absenceCount > 0 ? `
                            <div class="info-row">
                                <span class="info-label">Áº∫Âã§Ôºö</span>
                                <span class="info-value">${course.absenceCount}ËäÇ</span>
                            </div>
                        ` : ''}
                        <div class="info-row">
                            <span class="info-label">Â∫îÊî∂Ôºö</span>
                            <span class="info-value">${formatCurrency(courseFee)}</span>
                        </div>
                        ${course.absenceCount > 0 ? `
                            <div class="info-row">
                                <span class="info-label">ÂáèÂÖçÔºö</span>
                                <span class="info-value">-${formatCurrency(courseAbsenceFee)}</span>
                            </div>
                        ` : ''}
                        <div class="info-row" style="font-weight: 600; color: var(--primary);">
                            <span class="info-label">Â∞èËÆ°Ôºö</span>
                            <span class="info-value">${formatCurrency(courseFinal)}</span>
                        </div>
                    </div>
                `;
            });

            content += `
                </div>
                <div class="detail-section">
                    <div class="info-row">
                        <span class="info-label">ËØæÁ®ãÊÄªËÆ°Ôºö</span>
                        <span class="info-value">${formatCurrency(financial.totalFee)}</span>
                    </div>
                    ${financial.absenceFee > 0 ? `
                        <div class="info-row">
                            <span class="info-label">Áº∫Âã§ÂáèÂÖçÔºö</span>
                            <span class="info-value">-${formatCurrency(financial.absenceFee)}</span>
                        </div>
                    ` : ''}
                    ${financial.classRemaining > 0 ? `
                        <div class="info-row">
                            <span class="info-label">ËØæ‰ΩôÂáèÂÖçÔºö</span>
                            <span class="info-value">-${formatCurrency(financial.classRemaining)}</span>
                        </div>
                    ` : ''}
                    ${financial.discountPrice > 0 ? `
                        <div class="info-row">
                            <span class="info-label">‰ºòÊÉ†‰ª∑Ê†ºÔºö</span>
                            <span class="info-value">-${formatCurrency(financial.discountPrice)}</span>
                        </div>
                    ` : ''}
                    <div class="info-row final">
                        <span class="info-label">ÊúÄÁªàÂ∫îÊî∂Ôºö</span>
                        <span class="info-value final">${formatCurrency(financial.finalFee)}</span>
                    </div>
                </div>
            `;

            document.getElementById('detail-content').innerHTML = content;
            document.getElementById('detail-modal').classList.add('show');
        }

        function closeDetail() {
            document.getElementById('detail-modal').classList.remove('show');
            selectedStudentId = null;
        }

        function editCurrentStudent() {
            closeDetail();
            openForm(selectedStudentId);
        }

        function deleteCurrentStudent() {
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Â≠¶Áîü ${students.find(s => s.id === selectedStudentId).name} ÁöÑËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ`)) {
                students = students.filter(s => s.id !== selectedStudentId);
                saveStudents();
                closeDetail();
                renderStudents();
                renderSummary();
                alert('Â≠¶ÁîüÂ∑≤Âà†Èô§');
            }
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>
